<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Cyber Tic-Tac-Toe - Arsenal Studios LLC</title>
    
    <meta name="description" content="Play multiplayer Cyber Tic-Tac-Toe with a twist - only 3 pieces allowed on the board at once. Real-time multiplayer cyberpunk gaming experience.">
    <meta name="theme-color" content="#6366f1">
    
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/animations.css">
    <link rel="stylesheet" href="styles/effects.css">
    <link rel="stylesheet" href="styles/responsive.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/LogoGT.png">
    
    <style>
        .tictactoe-container {
            min-height: 100vh;
            padding: 2rem;
            background: var(--bg-darker);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .game-title {
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            color: var(--primary-color);
            text-shadow: 0 0 20px var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .game-subtitle {
            color: var(--text-secondary);
            font-size: 1.2rem;
            margin-bottom: 2rem;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
        }
        
        .player-name {
            font-family: 'Orbitron', monospace;
            color: var(--primary-color);
        }
        
        .current-turn {
            font-family: 'Space Mono', monospace;
            color: var(--accent-color);
            text-align: center;
            font-size: 1.1rem;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 4px;
            width: 400px;
            height: 400px;
            background: var(--primary-color);
            padding: 4px;
            margin-bottom: 2rem;
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
        }
        
        .game-cell {
            background: var(--bg-dark);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .game-cell:hover:not(.occupied) {
            background: var(--border-color);
            box-shadow: inset 0 0 20px rgba(99, 102, 241, 0.2);
        }
        
        .game-cell.occupied {
            cursor: not-allowed;
        }
        
        .game-cell.x {
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-color);
        }
        
        .game-cell.o {
            color: var(--secondary-color);
            text-shadow: 0 0 10px var(--secondary-color);
        }
        
        .game-cell.fadeout {
            animation: fadeOut 0.5s ease-in-out;
        }
        
        .game-cell.fadein {
            animation: placeAnimation 0.5s ease-out;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes placeAnimation {
            0% { transform: scale(0) rotate(180deg); }
            50% { transform: scale(1.2) rotate(0deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        .game-status {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .status-text {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            color: var(--accent-color);
            text-shadow: 0 0 10px var(--accent-color);
        }
        
        .game-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .control-btn {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 1rem 2rem;
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        
        .control-btn:hover {
            background: var(--primary-color);
            color: var(--bg-dark);
            box-shadow: 0 0 20px var(--primary-color);
        }
        
        .back-link {
            position: absolute;
            top: 2rem;
            left: 2rem;
            color: var(--primary-color);
            text-decoration: none;
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .back-link:hover {
            text-shadow: 0 0 10px var(--primary-color);
        }
        
        .lobby-section {
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            padding: 2rem;
            margin: 2rem auto;
            max-width: 800px;
            width: 100%;
        }
        
        .username-setup {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .username-input {
            background: var(--bg-darker);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            padding: 1rem;
            margin: 0.5rem;
            font-size: 1rem;
            width: 250px;
        }
        
        .username-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
        }
        
        .join-lobby-btn {
            background: var(--primary-color);
            border: none;
            color: var(--bg-dark);
            padding: 1rem 2rem;
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            margin-left: 1rem;
        }
        
        .join-lobby-btn:hover {
            box-shadow: 0 0 20px var(--primary-color);
            transform: translateY(-2px);
        }
        
        .lobby-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .online-players {
            background: var(--bg-darker);
            border: 2px solid var(--border-color);
            padding: 1.5rem;
        }
        
        .players-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .players-title {
            font-family: 'Orbitron', monospace;
            color: var(--primary-color);
            font-size: 1.2rem;
        }
        
        .players-count {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .player-filter {
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            padding: 0.8rem;
            margin-bottom: 1rem;
            width: 100%;
            font-size: 0.9rem;
        }
        
        .player-filter:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .player-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .player-item:hover {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .player-item.current-user {
            border-color: var(--accent-color);
            background: rgba(168, 85, 247, 0.1);
        }
        
        .player-item.in-game {
            opacity: 0.5;
            border-color: var(--text-muted);
        }
        
        .player-details {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .player-status {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
        }
        
        .challenge-btn {
            background: transparent;
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
            padding: 0.5rem 1rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        
        .challenge-btn:hover {
            background: var(--accent-color);
            color: var(--bg-dark);
        }
        
        .challenge-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .game-challenges {
            background: var(--bg-darker);
            border: 2px solid var(--border-color);
            padding: 1.5rem;
        }
        
        .challenges-title {
            font-family: 'Orbitron', monospace;
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        
        .challenge-item {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }
        
        .challenge-from {
            color: var(--text-primary);
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .challenge-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .accept-btn, .decline-btn {
            padding: 0.5rem 1rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            border: 2px solid;
        }
        
        .accept-btn {
            background: transparent;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .accept-btn:hover {
            background: var(--primary-color);
            color: var(--bg-dark);
        }
        
        .decline-btn {
            background: transparent;
            border-color: var(--text-muted);
            color: var(--text-muted);
        }
        
        .decline-btn:hover {
            background: var(--text-muted);
            color: var(--bg-dark);
        }
        
        .lobby-status {
            text-align: center;
            color: var(--text-secondary);
            margin: 1rem 0;
            font-style: italic;
        }
        
        .current-game-info {
            background: var(--bg-darker);
            border: 2px solid var(--primary-color);
            padding: 1rem;
            margin-bottom: 2rem;
            text-align: center;
            display: none;
        }
        
        .current-game-info.active {
            display: block;
        }
        
        .leave-game-btn {
            background: transparent;
            border: 2px solid var(--text-muted);
            color: var(--text-muted);
            padding: 0.8rem 1.5rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            margin-top: 1rem;
        }
        
        .leave-game-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        .game-rules {
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            padding: 1.5rem;
            max-width: 600px;
            width: 100%;
            margin-top: 2rem;
        }
        
        .rules-title {
            font-family: 'Orbitron', monospace;
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .rules-list {
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .rules-list li {
            margin-bottom: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .game-board {
                width: 300px;
                height: 300px;
            }
            
            .game-cell {
                font-size: 2rem;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .game-info {
                flex-direction: column;
                gap: 1rem;
            }
            
            .game-controls {
                flex-direction: column;
            }
            
            .control-btn {
                width: 100%;
            }
            
            .lobby-content {
                grid-template-columns: 1fr;
            }
            
            .username-input {
                width: 200px;
            }
            
            .join-lobby-btn {
                margin-left: 0;
                margin-top: 1rem;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="glitch-overlay"></div>
    <div class="matrix-rain"></div>
    
    <a href="/tictactoe.html" class="back-link">‚Üê BACK TO TIC-TAC-TOE</a>
    
    <div class="tictactoe-container">
        <div class="game-header">
            <h1 class="game-title glitch" data-text="MULTIPLAYER ARENA">MULTIPLAYER ARENA</h1>
            <p class="game-subtitle">Challenge operators across the digital realm</p>
        </div>
        
        <!-- Username Setup -->
        <div class="username-setup" id="usernameSetup">
            <h3 style="color: var(--primary-color); font-family: 'Orbitron', monospace; margin-bottom: 1rem;">ENTER THE ARENA</h3>
            <input type="text" id="usernameInput" class="username-input" placeholder="Enter your callsign..." maxlength="20">
            <button id="joinLobbyBtn" class="join-lobby-btn">JOIN LOBBY</button>
        </div>
        
        <!-- Lobby Section -->
        <div class="lobby-section" id="lobbySection" style="display: none;">
            <div class="lobby-status" id="lobbyStatus">Connected to Arsenal Network</div>
            
            <div class="lobby-content">
                <div class="online-players">
                    <div class="players-header">
                        <h3 class="players-title">ONLINE OPERATORS</h3>
                        <span class="players-count" id="playersCount">0 online</span>
                    </div>
                    <input type="text" class="player-filter" id="playerFilter" placeholder="Filter operators...">
                    <div class="player-list" id="playerList">
                        <div class="lobby-status">Scanning for operators...</div>
                    </div>
                </div>
                
                <div class="game-challenges">
                    <h3 class="challenges-title">INCOMING CHALLENGES</h3>
                    <div id="challengesList">
                        <div class="lobby-status">No pending challenges</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Current Game Info -->
        <div class="current-game-info" id="currentGameInfo">
            <h3 style="color: var(--primary-color); font-family: 'Orbitron', monospace;">MATCH IN PROGRESS</h3>
            <p id="gameInfoText">Playing against <span id="opponentName"></span></p>
            <button id="leaveGameBtn" class="leave-game-btn">FORFEIT MATCH</button>
        </div>
        
        <div class="game-info" id="gameInfo" style="display: none;">
            <div class="player-info">
                <img id="player1Avatar" class="player-avatar" src="" alt="Player 1">
                <span id="player1Name" class="player-name">Player 1</span>
                <span class="player-symbol">(X)</span>
            </div>
            <div class="current-turn" id="turnIndicator">
                Join the lobby to start playing
            </div>
            <div class="player-info">
                <img id="player2Avatar" class="player-avatar" src="" alt="Player 2">
                <span id="player2Name" class="player-name">Player 2</span>
                <span class="player-symbol">(O)</span>
            </div>
        </div>
        
        <div class="game-status">
            <div class="status-text" id="gameStatus">Ready to connect - Enter your callsign above</div>
        </div>
        
        <div class="game-board" id="gameBoard" style="display: none;">
            <!-- Game cells will be generated by JavaScript -->
        </div>
        
        <div class="game-controls" style="display: none;">
            <button class="control-btn" id="newGameBtn">NEW GAME</button>
            <button class="control-btn" id="resetBtn">RESET SCORE</button>
        </div>
        
        <div class="game-rules">
            <h3 class="rules-title">TACTICAL RULES</h3>
            <ul class="rules-list">
                <li>Each player can only have <strong>3 pieces</strong> on the board at once</li>
                <li>When you place a 4th piece, your <strong>oldest piece disappears</strong></li>
                <li>First to get 3 in a row (horizontal, vertical, or diagonal) wins</li>
                <li>Challenge other players from the lobby</li>
                <li>All moves sync in real-time across the network</li>
            </ul>
        </div>
    </div>
    
    <script type="importmap">
    {
      "imports": {
        "@websim/websim-socket": "https://esm.websim.com/@websim/websim-socket"
      }
    }
    </script>
    
    <script type="module">
        class MultiplayerTicTacToe {
            constructor() {
                this.board = Array(9).fill('');
                this.currentPlayer = 'X';
                this.gameActive = false;
                this.playerPieces = { X: [], O: [] };
                this.score = { X: 0, O: 0, draws: 0 };
                
                // Multiplayer properties
                this.room = null;
                this.username = '';
                this.inLobby = false;
                this.inGame = false;
                this.currentOpponent = null;
                this.mySymbol = null;
                this.challenges = new Map();
                this.playerFilter = '';
                
                this.init();
            }
            
            async init() {
                this.createBoard();
                this.setupEventListeners();
                this.updateDisplay();
                
                // Initialize WebsimSocket
                const { WebsimSocket } = await import('@websim/websim-socket');
                this.room = new WebsimSocket();
                await this.room.initialize();
                this.setupMultiplayerEvents();
                
                console.log('Multiplayer game initialized, client ID:', this.room.clientId);
            }
            
            setupMultiplayerEvents() {
                // Subscribe to presence updates (other players)
                this.room.subscribePresence((presence) => {
                    console.log('Presence updated:', presence);
                    if (this.inLobby) {
                        this.updatePlayersList();
                    }
                });
                
                // Subscribe to room state updates (game state, challenges)
                this.room.subscribeRoomState((roomState) => {
                    console.log('Room state updated:', roomState);
                    if (roomState.challenges) {
                        this.updateChallenges(roomState.challenges);
                    }
                    if (roomState.games && this.inGame) {
                        this.handleGameStateUpdate(roomState.games);
                    }
                });
                
                // Handle custom messages
                this.room.onmessage = (event) => {
                    console.log('Received message:', event.data);
                    const { type, data, clientId, username } = event.data;
                    
                    switch (type) {
                        case 'connected':
                            console.log(`Player connected: ${username}`);
                            if (this.inLobby) {
                                setTimeout(() => this.updatePlayersList(), 500);
                            }
                            break;
                        case 'disconnected':
                            console.log(`Player disconnected: ${username}`);
                            if (this.inLobby) {
                                setTimeout(() => this.updatePlayersList(), 500);
                            }
                            break;
                        case 'challenge_sent':
                            if (data.to === this.room.clientId) {
                                this.handleChallengeReceived(data);
                            }
                            break;
                        case 'challenge_accepted':
                            if (data.challengerId === this.room.clientId) {
                                this.handleChallengeAccepted(data);
                            }
                            break;
                        case 'challenge_declined':
                            if (data.challengerId === this.room.clientId) {
                                this.handleChallengeDeclined(data);
                            }
                            break;
                        case 'game_move':
                            if (this.currentOpponent === clientId) {
                                this.handleOpponentMove(data);
                            }
                            break;
                        case 'game_ended':
                            if (this.currentOpponent === clientId) {
                                this.handleGameEnded(data);
                            }
                            break;
                    }
                };
            }
            
            createBoard() {
                const boardElement = document.getElementById('gameBoard');
                boardElement.innerHTML = '';
                
                for (let i = 0; i < 9; i++) {
                    const cell = document.createElement('button');
                    cell.className = 'game-cell';
                    cell.setAttribute('data-index', i);
                    cell.addEventListener('click', () => this.handleCellClick(i));
                    boardElement.appendChild(cell);
                }
            }
            
            setupEventListeners() {
                // Username and lobby setup
                document.getElementById('joinLobbyBtn').addEventListener('click', () => {
                    this.joinLobby();
                });

                document.getElementById('usernameInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.joinLobby();
                    }
                });
                
                // Player filter
                document.getElementById('playerFilter').addEventListener('input', (e) => {
                    this.playerFilter = e.target.value.toLowerCase();
                    this.updatePlayersList();
                });
                
                // Leave game
                document.getElementById('leaveGameBtn').addEventListener('click', () => {
                    this.leaveGame();
                });
                
                // Control buttons
                document.getElementById('newGameBtn').addEventListener('click', () => this.startNewGame());
                document.getElementById('resetBtn').addEventListener('click', () => this.resetScore());
            }
            
            joinLobby() {
                const usernameInput = document.getElementById('usernameInput');
                const username = usernameInput.value.trim();
                
                if (!username || username.length < 2) {
                    alert('Please enter a valid callsign (at least 2 characters)');
                    return;
                }
                
                if (username.length > 20) {
                    alert('Callsign must be 20 characters or less');
                    return;
                }
                
                this.username = username;
                this.inLobby = true;
                
                console.log('Joining lobby as:', username);
                
                // Update presence with username and status
                this.room.updatePresence({
                    username: this.username,
                    status: 'lobby',
                    inGame: false,
                    lastSeen: Date.now()
                });
                
                // Hide username setup, show lobby
                document.getElementById('usernameSetup').style.display = 'none';
                document.getElementById('lobbySection').style.display = 'block';
                
                // Update lobby status
                document.getElementById('lobbyStatus').textContent = `Connected as ${username}`;
                
                // Force update players list
                setTimeout(() => {
                    this.updatePlayersList();
                }, 1000);
            }
            
            updatePlayersList() {
                const playerList = document.getElementById('playerList');
                const playersCount = document.getElementById('playersCount');
                
                console.log('Updating players list');
                console.log('Current peers:', this.room.peers);
                console.log('Current presence:', this.room.presence);
                
                // Get all connected peers with presence data
                const allPeers = Object.keys(this.room.presence)
                    .map(peerId => ({
                        id: peerId,
                        ...this.room.peers[peerId],
                        presence: this.room.presence[peerId]
                    }))
                    .filter(peer => peer.presence && peer.presence.username && peer.presence.status === 'lobby');
                
                console.log('Lobby players:', allPeers);
                
                // Apply search filter
                const filteredPlayers = allPeers.filter(player => {
                    if (!this.playerFilter) return true;
                    return player.presence.username.toLowerCase().includes(this.playerFilter.toLowerCase());
                });
                
                playersCount.textContent = `${allPeers.length} online`;
                
                if (filteredPlayers.length === 0) {
                    playerList.innerHTML = '<div class="lobby-status">No operators found</div>';
                    return;
                }
                
                playerList.innerHTML = '';
                
                filteredPlayers.forEach(player => {
                    const isCurrentUser = player.id === this.room.clientId;
                    const isInGame = player.presence.inGame;
                    
                    console.log('Adding player to list:', player.presence.username, player.id);
                    
                    const playerItem = document.createElement('div');
                    playerItem.className = 'player-item';
                    
                    if (isCurrentUser) {
                        playerItem.classList.add('current-user');
                    }
                    
                    if (isInGame) {
                        playerItem.classList.add('in-game');
                    }
                    
                    const avatarUrl = player.avatarUrl || `https://images.websim.com/avatar/${player.presence.username}`;
                    
                    playerItem.innerHTML = `
                        <div class="player-details">
                            <img src="${avatarUrl}" alt="${player.presence.username}" class="player-avatar">
                            <div>
                                <div class="player-name">${player.presence.username}</div>
                                <div class="player-status">${isCurrentUser ? 'You' : isInGame ? 'In Game' : 'Available'}</div>
                            </div>
                        </div>
                        ${!isCurrentUser && !isInGame && !this.inGame ? 
                            `<button class="challenge-btn" onclick="window.game.sendChallenge('${player.id}')">Challenge</button>` : 
                            ''
                        }
                    `;
                    
                    playerList.appendChild(playerItem);
                });
            }
            
            sendChallenge(playerId) {
                console.log('Sending challenge to:', playerId);
                
                const targetPresence = this.room.presence[playerId];
                
                if (!targetPresence) {
                    console.error('Target player not found:', playerId);
                    return;
                }
                
                const challengeId = `${this.room.clientId}_${playerId}_${Date.now()}`;
                
                console.log('Challenge ID:', challengeId);
                
                // Update room state with challenge
                const currentChallenges = this.room.roomState.challenges || {};
                const updatedChallenges = {
                    ...currentChallenges,
                    [challengeId]: {
                        id: challengeId,
                        from: this.room.clientId,
                        to: playerId,
                        fromUsername: this.username,
                        toUsername: targetPresence.username,
                        timestamp: Date.now(),
                        status: 'pending'
                    }
                };
                
                this.room.updateRoomState({ challenges: updatedChallenges });
                
                // Also send direct message
                this.room.send({
                    type: 'challenge_sent',
                    data: {
                        id: challengeId,
                        from: this.room.clientId,
                        to: playerId,
                        fromUsername: this.username,
                        toUsername: targetPresence.username
                    }
                });
                
                // Update UI
                document.getElementById('lobbyStatus').textContent = 
                    `Challenge sent to ${targetPresence.username}`;
                
                console.log('Challenge sent successfully');
            }
            
            handleChallengeReceived(data) {
                console.log('Challenge received:', data);
                this.updateChallenges(this.room.roomState.challenges || {});
            }
            
            updateChallenges(challenges) {
                console.log('Updating challenges:', challenges);
                
                const challengesList = document.getElementById('challengesList');
                
                // Find challenges for current user
                const myPendingChallenges = Object.values(challenges || {})
                    .filter(challenge => 
                        challenge.to === this.room.clientId && 
                        challenge.status === 'pending'
                    );
                
                console.log('My pending challenges:', myPendingChallenges);
                
                if (myPendingChallenges.length === 0) {
                    challengesList.innerHTML = '<div class="lobby-status">No pending challenges</div>';
                    return;
                }
                
                challengesList.innerHTML = '';
                
                myPendingChallenges.forEach(challenge => {
                    const challengeItem = document.createElement('div');
                    challengeItem.className = 'challenge-item';
                    
                    challengeItem.innerHTML = `
                        <div class="challenge-from">Challenge from ${challenge.fromUsername}</div>
                        <div class="challenge-actions">
                            <button class="accept-btn" onclick="window.game.acceptChallenge('${challenge.id}')">Accept</button>
                            <button class="decline-btn" onclick="window.game.declineChallenge('${challenge.id}')">Decline</button>
                        </div>
                    `;
                    
                    challengesList.appendChild(challengeItem);
                });
            }
            
            acceptChallenge(challengeId) {
                console.log('Accepting challenge:', challengeId);
                
                const currentChallenges = this.room.roomState.challenges || {};
                const challenge = currentChallenges[challengeId];
                
                if (!challenge) {
                    console.error('Challenge not found:', challengeId);
                    return;
                }
                
                // Update challenge status and remove from room state
                const updatedChallenges = { ...currentChallenges };
                delete updatedChallenges[challengeId];
                this.room.updateRoomState({ challenges: updatedChallenges });
                
                // Start game
                this.startMultiplayerGame(challenge.from, challenge.fromUsername);
                
                // Notify the challenger
                this.room.send({
                    type: 'challenge_accepted',
                    data: {
                        challengeId,
                        challengerId: challenge.from,
                        acceptedBy: this.username,
                        acceptedById: this.room.clientId
                    }
                });
                
                console.log('Challenge accepted, starting game');
            }
            
            declineChallenge(challengeId) {
                console.log('Declining challenge:', challengeId);
                
                const currentChallenges = this.room.roomState.challenges || {};
                const challenge = currentChallenges[challengeId];
                
                if (!challenge) {
                    console.error('Challenge not found:', challengeId);
                    return;
                }
                
                // Remove challenge from room state
                const updatedChallenges = { ...currentChallenges };
                delete updatedChallenges[challengeId];
                this.room.updateRoomState({ challenges: updatedChallenges });
                
                // Notify the challenger
                this.room.send({
                    type: 'challenge_declined',
                    data: {
                        challengeId,
                        challengerId: challenge.from,
                        declinedBy: this.username
                    }
                });
                
                console.log('Challenge declined');
            }
            
            handleChallengeAccepted(data) {
                console.log('Challenge was accepted:', data);
                this.startMultiplayerGame(data.acceptedById, data.acceptedBy);
                document.getElementById('lobbyStatus').textContent = 
                    `${data.acceptedBy} accepted your challenge!`;
            }
            
            handleChallengeDeclined(data) {
                console.log('Challenge was declined:', data);
                document.getElementById('lobbyStatus').textContent = 
                    `${data.declinedBy} declined your challenge`;
            }
            
            startMultiplayerGame(opponentId, opponentUsername) {
                this.inGame = true;
                this.currentOpponent = opponentId;
                this.mySymbol = this.room.clientId < opponentId ? 'X' : 'O';
                
                // Update presence
                this.room.updatePresence({
                    username: this.username,
                    status: 'game',
                    inGame: true,
                    opponent: opponentId
                });
                
                // Show game elements
                document.getElementById('lobbySection').style.display = 'none';
                document.getElementById('currentGameInfo').classList.add('active');
                document.getElementById('gameInfo').style.display = 'flex';
                document.getElementById('gameBoard').style.display = 'grid';
                document.querySelector('.game-controls').style.display = 'flex';
                document.getElementById('opponentName').textContent = opponentUsername;
                
                // Setup game UI for multiplayer
                this.setupMultiplayerGameUI(opponentUsername);
                
                // Start the game
                this.startNewGame();
            }
            
            setupMultiplayerGameUI(opponentUsername) {
                const player1Name = document.getElementById('player1Name');
                const player2Name = document.getElementById('player2Name');
                const player1Avatar = document.getElementById('player1Avatar');
                const player2Avatar = document.getElementById('player2Avatar');
                
                if (this.mySymbol === 'X') {
                    player1Name.textContent = this.username;
                    player2Name.textContent = opponentUsername;
                    player1Avatar.src = this.room.peers[this.room.clientId]?.avatarUrl || `https://images.websim.com/avatar/${this.username}`;
                    player2Avatar.src = this.room.peers[this.currentOpponent]?.avatarUrl || `https://images.websim.com/avatar/${opponentUsername}`;
                } else {
                    player1Name.textContent = opponentUsername;
                    player2Name.textContent = this.username;
                    player1Avatar.src = this.room.peers[this.currentOpponent]?.avatarUrl || `https://images.websim.com/avatar/${opponentUsername}`;
                    player2Avatar.src = this.room.peers[this.room.clientId]?.avatarUrl || `https://images.websim.com/avatar/${this.username}`;
                }
            }
            
            leaveGame() {
                if (this.inGame && this.currentOpponent) {
                    // Notify opponent
                    this.room.send({
                        type: 'game_ended',
                        targetClient: this.currentOpponent,
                        data: {
                            reason: 'forfeit'
                        }
                    });
                }
                
                this.endMultiplayerGame();
            }
            
            endMultiplayerGame() {
                this.inGame = false;
                this.currentOpponent = null;
                this.mySymbol = null;
                
                // Update presence
                this.room.updatePresence({
                    username: this.username,
                    status: 'lobby',
                    inGame: false
                });
                
                // Show lobby, hide game
                document.getElementById('lobbySection').style.display = 'block';
                document.getElementById('currentGameInfo').classList.remove('active');
                document.getElementById('gameInfo').style.display = 'none';
                document.getElementById('gameBoard').style.display = 'none';
                document.querySelector('.game-controls').style.display = 'none';
                
                // Reset game state
                this.board = Array(9).fill('');
                this.currentPlayer = 'X';
                this.gameActive = false;
                this.playerPieces = { X: [], O: [] };
                
                this.updateBoard();
                this.updateDisplay();
                this.updatePlayersList();
            }
            
            handleGameEnded(data) {
                console.log('Game ended by opponent:', data);
                
                if (data.reason === 'forfeit') {
                    document.getElementById('gameStatus').textContent = 
                        'Opponent forfeited - You win!';
                }
                
                setTimeout(() => {
                    this.endMultiplayerGame();
                }, 3000);
            }
            
            startNewGame() {
                this.board = Array(9).fill('');
                this.currentPlayer = 'X';
                this.gameActive = true;
                this.playerPieces = { X: [], O: [] };
                
                this.updateBoard();
                this.updateDisplay();
                
                console.log('New multiplayer game started');
            }
            
            handleCellClick(index) {
                console.log('Cell clicked:', index, 'Game active:', this.gameActive);
                
                if (!this.gameActive || !this.inGame) {
                    console.log('Game not active or not in game');
                    return;
                }
                
                if (this.currentPlayer !== this.mySymbol) {
                    console.log('Not my turn');
                    return;
                }
                
                if (this.board[index] !== '') {
                    console.log('Cell already occupied');
                    return;
                }
                
                this.makeMove(index);
            }
            
            makeMove(cellIndex) {
                console.log('Making move:', cellIndex, 'Current player:', this.currentPlayer);
                
                // Handle the 3-piece rule
                const currentPlayerPieces = this.playerPieces[this.currentPlayer];
                if (currentPlayerPieces.length >= 3) {
                    const oldestPieceIndex = currentPlayerPieces.shift();
                    this.board[oldestPieceIndex] = '';
                    console.log('Removed oldest piece from:', oldestPieceIndex);
                    
                    // Add visual feedback for removal
                    const oldCell = document.querySelector(`[data-index="${oldestPieceIndex}"]`);
                    if (oldCell) {
                        oldCell.classList.add('fadeout');
                        setTimeout(() => oldCell.classList.remove('fadeout'), 500);
                    }
                }
                
                // Place the new piece
                this.board[cellIndex] = this.currentPlayer;
                this.playerPieces[this.currentPlayer].push(cellIndex);
                console.log('Placed piece at:', cellIndex, 'Player pieces:', this.playerPieces);
                
                // Add visual feedback for placement
                const newCell = document.querySelector(`[data-index="${cellIndex}"]`);
                if (newCell) {
                    newCell.classList.add('fadein');
                    setTimeout(() => newCell.classList.remove('fadein'), 500);
                }
                
                // Send move to opponent
                this.room.send({
                    type: 'game_move',
                    data: {
                        cellIndex,
                        player: this.currentPlayer,
                        board: this.board,
                        playerPieces: this.playerPieces
                    }
                });
                
                this.updateBoard();
                
                // Check for win condition
                const winner = this.checkWinner();
                if (winner) {
                    console.log('Winner found:', winner);
                    this.endGame(winner);
                    return;
                }
                
                // Switch turns
                this.currentPlayer = this.currentPlayer === 'X' ? 'O' : 'X';
                this.updateDisplay();
            }
            
            handleOpponentMove(data) {
                console.log('Received opponent move:', data);
                
                if (!this.inGame || this.currentPlayer === this.mySymbol) {
                    return;
                }
                
                // Apply the opponent's move
                this.board = data.board;
                this.playerPieces = data.playerPieces;
                this.currentPlayer = data.player;
                
                this.updateBoard();
                
                // Check for win condition
                const winner = this.checkWinner();
                if (winner) {
                    this.endGame(winner);
                    return;
                }
                
                // Switch turns
                this.currentPlayer = this.currentPlayer === 'X' ? 'O' : 'X';
                this.updateDisplay();
            }
            
            checkWinner() {
                const winPatterns = [
                    [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
                    [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
                    [0, 4, 8], [2, 4, 6] // diagonals
                ];
                
                for (let pattern of winPatterns) {
                    const [a, b, c] = pattern;
                    if (this.board[a] && this.board[a] === this.board[b] && this.board[a] === this.board[c]) {
                        return this.board[a];
                    }
                }
                
                return null;
            }
            
            endGame(result) {
                console.log('Game ended with result:', result);
                this.gameActive = false;
                
                if (result === 'draw') {
                    this.score.draws++;
                } else {
                    this.score[result]++;
                }
                
                // Notify opponent and end the game
                this.room.send({
                    type: 'game_ended',
                    targetClient: this.currentOpponent,
                    data: {
                        reason: 'win',
                        winner: result
                    }
                });
                
                setTimeout(() => {
                    this.endMultiplayerGame();
                }, 3000);
                
                this.updateDisplay();
            }
            
            resetScore() {
                this.score = { X: 0, O: 0, draws: 0 };
                this.updateDisplay();
            }
            
            updateBoard() {
                const cells = document.querySelectorAll('.game-cell');
                cells.forEach((cell, index) => {
                    const value = this.board[index];
                    cell.textContent = value;
                    cell.className = 'game-cell';
                    
                    if (value) {
                        cell.classList.add('occupied', value.toLowerCase());
                    }
                });
            }
            
            updateDisplay() {
                const turnIndicator = document.getElementById('turnIndicator');
                const gameStatus = document.getElementById('gameStatus');
                
                if (!this.gameActive) {
                    const winner = this.checkWinner();
                    if (winner) {
                        const winnerName = winner === this.mySymbol ? 'YOU WIN!' : 'YOU LOSE!';
                        turnIndicator.textContent = winnerName;
                        gameStatus.textContent = `Score - X: ${this.score.X} | O: ${this.score.O} | Draws: ${this.score.draws}`;
                    } else {
                        turnIndicator.textContent = 'Game Over';
                        gameStatus.textContent = 'Click NEW GAME to start';
                    }
                } else if (this.inGame) {
                    const isMyTurn = this.currentPlayer === this.mySymbol;
                    turnIndicator.textContent = isMyTurn ? `Your Turn (${this.mySymbol})` : `Opponent's Turn (${this.currentPlayer})`;
                    gameStatus.textContent = isMyTurn ? 'Make your move!' : 'Waiting for opponent...';
                    
                    // Update piece counts
                    const xCount = this.playerPieces.X.length;
                    const oCount = this.playerPieces.O.length;
                    gameStatus.textContent += ` | Pieces: X:${xCount}/3, O:${oCount}/3`;
                } else {
                    turnIndicator.textContent = 'Join the lobby to start playing';
                    gameStatus.textContent = 'Ready to connect - Enter your callsign above';
                }
            }
        }
        
        // Initialize the game when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing Multiplayer Cyber Tic-Tac-Toe');
            window.game = new MultiplayerTicTacToe();
        });
    </script>
</body>
</html>